services:
  # ===================================================================
  # DATABASES
  # ===================================================================

  # PostgreSQL 17 for Auth Service
  postgres:
    image: postgres:17-alpine
    container_name: dubaomatrung-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres123}
      POSTGRES_DB: auth_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Auto-import SQL on first run (if database doesn't exist)
      - ./docker-init/postgres:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # PostGIS 17 for GIS Service
  postgis:
    image: postgis/postgis:17-3.5-alpine
    container_name: dubaomatrung-postgis
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres123}
      POSTGRES_DB: gis_db
    ports:
      - "5433:5432"
    volumes:
      - postgis_data:/var/lib/postgresql/data
      # Auto-import SQL on first run
      - ./docker-init/postgis:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d gis_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # PostGIS 17 for Admin Service
  admin-postgis:
    image: postgis/postgis:17-3.5-alpine
    container_name: dubaomatrung-admin-postgis
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres123}
      POSTGRES_DB: admin_db
    ports:
      - "5434:5432"
    volumes:
      - admin_postgis_data:/var/lib/postgresql/data
      # Auto-import SQL on first run (2.5GB database)
      - ./docker-init/admin-postgis:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d admin_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s
    # Increase resources for large database import
    shm_size: 256mb
    deploy:
      resources:
        limits:
          memory: 4G

  # MongoDB for Logging
  mongodb:
    image: mongo:7.0
    container_name: dubaomatrung-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: logging_db
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      # Auto-import MongoDB data if exists
      - ./docker-init/mongodb:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 60s

  # Redis for GIS Cache
  redis:
    image: redis:7-alpine
    container_name: dubaomatrung-redis
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===================================================================
  # MICROSERVICES
  # ===================================================================

  # API Gateway
  gateway:
    build:
      context: ./microservices
      dockerfile: gateway/Dockerfile
    container_name: dubaomatrung-gateway
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - JWT_SECRET=${JWT_SECRET}
      - FRONTEND_URL=http://localhost:5173
      - AUTH_SERVICE_URL=http://auth-service:3001
      - USER_SERVICE_URL=http://user-service:3002
      - GIS_SERVICE_URL=http://gis-service:3003
      - REPORT_SERVICE_URL=http://report-service:3004
      - ADMIN_SERVICE_URL=http://admin-service:3005
      - SEARCH_SERVICE_URL=http://search-service:3006
      - MONGODB_URI=mongodb://mongodb:27017/logging_db
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Auth Service
  auth-service:
    build:
      context: ./microservices
      dockerfile: services/auth-service/Dockerfile
    container_name: dubaomatrung-auth
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=${DB_PASSWORD:-postgres123}
      - DB_NAME=auth_db
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD:-postgres123}@postgres:5432/auth_db
      - JWT_SECRET=${JWT_SECRET}
      - MONGODB_URI=mongodb://mongodb:27017/logging_db
      - GATEWAY_URL=http://gateway:3000
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3

  # User Service
  user-service:
    build:
      context: ./microservices
      dockerfile: services/user-service/Dockerfile
    container_name: dubaomatrung-user
    restart: unless-stopped
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=${DB_PASSWORD:-postgres123}
      - DB_NAME=auth_db
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD:-postgres123}@postgres:5432/auth_db
      - JWT_SECRET=${JWT_SECRET}
      - MONGODB_URI=mongodb://mongodb:27017/logging_db
      - GATEWAY_URL=http://gateway:3000
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  # GIS Service
  gis-service:
    build:
      context: ./microservices
      dockerfile: services/gis-service/Dockerfile
    container_name: dubaomatrung-gis
    restart: unless-stopped
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - PORT=3003
      - DB_HOST=postgis
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=${DB_PASSWORD:-postgres123}
      - DB_NAME=gis_db
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD:-postgres123}@postgis:5432/gis_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MONGODB_URI=mongodb://mongodb:27017/logging_db
      - GATEWAY_URL=http://gateway:3000
      - MAX_FILE_SIZE=104857600
    depends_on:
      postgis:
        condition: service_healthy
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    volumes:
      - gis_uploads:/app/uploads

  # Report Service
  report-service:
    build:
      context: ./microservices
      dockerfile: services/report-service/Dockerfile
    container_name: dubaomatrung-report
    restart: unless-stopped
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=production
      - PORT=3004
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=${DB_PASSWORD:-postgres123}
      - DB_NAME=auth_db
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD:-postgres123}@postgres:5432/auth_db
      - MONGODB_URI=mongodb://mongodb:27017/logging_db
      - GATEWAY_URL=http://gateway:3000
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  # Admin Service
  admin-service:
    build:
      context: ./microservices
      dockerfile: services/admin-service/Dockerfile
    container_name: dubaomatrung-admin
    restart: unless-stopped
    ports:
      - "3005:3005"
    environment:
      - NODE_ENV=production
      - PORT=3005
      - DB_HOST=admin-postgis
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=${DB_PASSWORD:-postgres123}
      - DB_NAME=admin_db
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD:-postgres123}@admin-postgis:5432/admin_db
      - MONGODB_URI=mongodb://mongodb:27017/logging_db
      - GATEWAY_URL=http://gateway:3000
    depends_on:
      admin-postgis:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  # Search Service
  search-service:
    build:
      context: ./microservices
      dockerfile: services/search-service/Dockerfile
    container_name: dubaomatrung-search
    restart: unless-stopped
    ports:
      - "3006:3006"
    environment:
      - NODE_ENV=production
      - PORT=3006
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASSWORD=${DB_PASSWORD:-postgres123}
      - DB_NAME=auth_db
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD:-postgres123}@postgres:5432/auth_db
      - MONGODB_URI=mongodb://mongodb:27017/logging_db
      - GATEWAY_URL=http://gateway:3000
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  # MapServer Service
  mapserver-service:
    build:
      context: ./microservices
      dockerfile: services/mapserver-service/Dockerfile
    container_name: dubaomatrung-mapserver
    restart: unless-stopped
    ports:
      - "3007:3007"
    environment:
      - NODE_ENV=production
      - PORT=3007
      - MONGODB_URI=mongodb://mongodb:27017/logging_db
      - GATEWAY_URL=http://gateway:3000
    volumes:
      - ./mapserver:/mapserver:ro
    depends_on:
      mongodb:
        condition: service_healthy

  # ===================================================================
  # FRONTEND
  # ===================================================================

  client:
    build:
      context: ./client
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=http://103.56.161.239:3000
    container_name: dubaomatrung-client
    restart: unless-stopped
    ports:
      - "5173:80"
    depends_on:
      - gateway

# ===================================================================
# VOLUMES
# ===================================================================

volumes:
  postgres_data:
  postgis_data:
  admin_postgis_data:
  mongodb_data:
  redis_data:
  gis_uploads:

# ===================================================================
# NETWORKS
# ===================================================================

networks:
  default:
    name: dubaomatrung-network
